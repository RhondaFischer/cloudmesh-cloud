

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>9. CM4 Details &mdash; cm4 alpha documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="10. Cloudmesh cm v4" href="README.html" />
    <link rel="prev" title="8. Vagrant" href="vagrant.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> cm4
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="about.html">1. About</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributors.html">2. Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">3. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">4. Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="mongo.html">5. Cloudmesh Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">6. Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="vmproviders.html">7. VM Providers</a></li>
<li class="toctree-l1"><a class="reference internal" href="vagrant.html">8. Vagrant</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">9. CM4 Details</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#extra-vargrant">9.1. Extra: Vargrant</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-we-have-implemented">9.2. What we have implemented</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-preparation-for-installing-cm4-david">9.2.1. The Preparation for installing <code class="docutils literal notranslate"><span class="pre">cm4</span></code> (David)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-configuration-files-and-some-relative-function-classes-sachith">9.2.2. The Configuration files and some relative function classes (Sachith)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#use-the-configurations-file">9.2.2.1. Use the Configurations file</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-counter-file">9.2.3. Using the Counter file</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#using-the-counter">9.2.3.1. Using the counter</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-mongodb-database-in-cm4-yu">9.2.4. The MongoDB Database in <code class="docutils literal notranslate"><span class="pre">cm4</span></code> (Yu)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#data-scheme-in-mongodb">9.2.4.1. Data Scheme in MongoDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="#security-in-mongodb">9.2.4.2. Security in MongoDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="#install-mongodb-into-local">9.2.4.3. Install MongoDB Into Local</a></li>
<li class="toctree-l4"><a class="reference internal" href="#insert-and-update-documents-in-mongodb">9.2.4.4. Insert and Update Documents in MongoDB</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-virtual-machine-provider">9.2.5. The Virtual Machine Provider</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#execute-command-in-mongodb">9.2.5.1. Execute Command in  MongoDB</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-virtual-machine-provider">9.2.6. 4. The Virtual Machine Provider</a></li>
<li class="toctree-l3"><a class="reference internal" href="#aws-vm-operations-yu">9.2.7. AWS VM Operations (Yu)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#azure-vm-operation-david">9.2.8. Azure VM Operation (David)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#chameleon-vm-operation-rui-and-kimball">9.2.9. Chameleon VM Operation (Rui and Kimball)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vm-refactor-rui">9.2.10. VM Refactor (Rui)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#flask-rest-api-sachith">9.3. Flask Rest API (Sachith)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pre-requisites">9.3.1. Pre-requisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-run-the-rest-api">9.3.2. How to run the REST API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api">9.3.3. API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#examples">9.3.4. Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dev-restricting-certain-ips-for-certain-rest-calls">9.3.5. Dev - restricting certain ips for certain rest calls</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#extra-run-command-script-in-aws-by-cm4">9.4. Extra: Run Command/Script in AWS by <code class="docutils literal notranslate"><span class="pre">cm4</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="README.html">10. Cloudmesh cm v4</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws.html">11. AWS cm</a></li>
<li class="toctree-l1"><a class="reference internal" href="ufo.html">12. CM4 REST Api</a></li>
<li class="toctree-l1"><a class="reference internal" href="vcluster.html">13. Virtual Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="vm.html">14. VM Description</a></li>
<li class="toctree-l1"><a class="reference internal" href="jupyter.html">15. Jupyter Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="manual.html">16. Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="manual-dev.html">17. Manual - Dev</a></li>
<li class="toctree-l1"><a class="reference internal" href="code.html">18. Code Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">cm4</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>9. CM4 Details</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/CM4README.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="cm4-details">
<span id="cm4-details"></span><h1>9. CM4 Details<a class="headerlink" href="#cm4-details" title="Permalink to this headline">¶</a></h1>
<p>In cloudmesh cm4, we are using the <strong>Python</strong> tool to implement a
program that could remotely control cloud nodes provided by different
organizations and run experiments in parallel.</p>
<p>The goal of <em><code class="docutils literal notranslate"><span class="pre">cm4</span></code></em> is to provide a platform that users could directly
control the nodes they have, like AWS, Azure, and OPENSTACK
instances. Users could decide to start, stop, destroy, create, resume,
and suspend different nodes without accessing the <strong>Console</strong>
interfaces of providers. Then users could install experiment
environment, software, and other required tools in these running
nodes. Finally, an experiment could be executed in running nodes by
sending the commands from <em><code class="docutils literal notranslate"><span class="pre">cm4</span></code></em> platform. Meanwhile, we embed the
NoSQL database <strong>MongoDB</strong> into cm4 for managing the nodes and
experiments.</p>
<div class="section" id="extra-vargrant">
<span id="extra-vargrant"></span><h2>9.1. Extra: Vargrant<a class="headerlink" href="#extra-vargrant" title="Permalink to this headline">¶</a></h2>
<p>Please refer to <a class="reference external" href="https://github.com/cloudmesh-community/cm/tree/master/cm4/vagrant/README.md">here</a> to see how to setup
Vagrant with cm4.</p>
</div>
<div class="section" id="what-we-have-implemented">
<span id="what-we-have-implemented"></span><h2>9.2. What we have implemented<a class="headerlink" href="#what-we-have-implemented" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>the function to install <code class="docutils literal notranslate"><span class="pre">cm4</span></code> and its required packages</li>
<li>the function to manage the virtual machines from cloud service providers (Azure, AWS, and Openstack)</li>
<li>the function to use <em>MongoDB</em> for saving data</li>
</ul>
<div class="section" id="the-preparation-for-installing-cm4-david">
<span id="the-preparation-for-installing-cm4-david"></span><h3>9.2.1. The Preparation for installing <code class="docutils literal notranslate"><span class="pre">cm4</span></code> (David)<a class="headerlink" href="#the-preparation-for-installing-cm4-david" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>requriements.txt : the required packages</li>
<li>setup.py</li>
<li>cm4/command/command.py : the python class defines the interface for the command-line <code class="docutils literal notranslate"><span class="pre">cm4</span></code></li>
</ul>
<div class="highlight-commandline notranslate"><div class="highlight"><pre><span></span>$ cm4
Usage:
      cm4 admin mongo install [--brew] [--download=PATH]
      cm4 admin mongo status
      cm4 admin mongo start
      cm4 admin mongo stop
      cm4 admin mongo backup FILENAME
      ...
</pre></div>
</div>
</div>
<div class="section" id="the-configuration-files-and-some-relative-function-classes-sachith">
<span id="the-configuration-files-and-some-relative-function-classes-sachith"></span><h3>9.2.2. The Configuration files and some relative function classes (Sachith)<a class="headerlink" href="#the-configuration-files-and-some-relative-function-classes-sachith" title="Permalink to this headline">¶</a></h3>
<p>The cloudmesh4.yaml file contains all the configurations required for CM4 to run.
By default it’s located in the Cloudmesh home directory (~/.cloudmesh/cloudmesh4.yaml).</p>
<div class="section" id="use-the-configurations-file">
<span id="use-the-configurations-file"></span><h4>9.2.2.1. Use the Configurations file<a class="headerlink" href="#use-the-configurations-file" title="Permalink to this headline">¶</a></h4>
<p>To use the configurations in CM4, you need to import the Config class and use the config
object provided by that class to access and manipulate the configuration file.</p>
<div class="section" id="getting-the-config-object">
<span id="getting-the-config-object"></span><h5>9.2.2.1.1. Getting the config object<a class="headerlink" href="#getting-the-config-object" title="Permalink to this headline">¶</a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cm4.configuration.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cloudmesh&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="getting-values">
<span id="getting-values"></span><h5>9.2.2.1.2. Getting values<a class="headerlink" href="#getting-values" title="Permalink to this headline">¶</a></h5>
<p>To get values from the configurations, you can call level by level from top-down config.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">MONGO_HOST</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;mongo&quot;</span><span class="p">][</span><span class="s2">&quot;MONGO_HOST&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="using-the-counter-file">
<span id="using-the-counter-file"></span><h3>9.2.3. Using the Counter file<a class="headerlink" href="#using-the-counter-file" title="Permalink to this headline">¶</a></h3>
<p>CM4 keeps track of all the VMs running using counters for each VM.
The counter file is located at</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/.cloudmesh/counter.yaml
</pre></div>
</div>
<div class="section" id="using-the-counter">
<span id="using-the-counter"></span><h4>9.2.3.1. Using the counter<a class="headerlink" href="#using-the-counter" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cm4.configuration.counter</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="incrementing-and-decrementing-the-counter-values">
<span id="incrementing-and-decrementing-the-counter-values"></span><h5>9.2.3.1.1. Incrementing and Decrementing the counter values<a class="headerlink" href="#incrementing-and-decrementing-the-counter-values" title="Permalink to this headline">¶</a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># to update a specific VM counter</span>
<span class="n">counter</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s2">&quot;&lt;VM_NAME&gt;&quot;</span><span class="p">)</span>
<span class="n">counter</span><span class="o">.</span><span class="n">decr</span><span class="p">(</span><span class="s2">&quot;&lt;VM_NAME&gt;&quot;</span><span class="p">)</span>

<span class="c1"># to update the total vm counter</span>
<span class="n">counter</span><span class="o">.</span><span class="n">incr</span><span class="p">()</span>
<span class="n">counter</span><span class="o">.</span><span class="n">decr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="getting-and-setting-the-counter-values">
<span id="getting-and-setting-the-counter-values"></span><h5>9.2.3.1.2. Getting and Setting the counter values<a class="headerlink" href="#getting-and-setting-the-counter-values" title="Permalink to this headline">¶</a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># to update a specific VM counter</span>
<span class="n">counter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&lt;VM_NAME&gt;&quot;</span><span class="p">)</span>
<span class="n">counter</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;&lt;VM_NAME&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="the-mongodb-database-in-cm4-yu">
<span id="the-mongodb-database-in-cm4-yu"></span><h3>9.2.4. The MongoDB Database in <code class="docutils literal notranslate"><span class="pre">cm4</span></code> (Yu)<a class="headerlink" href="#the-mongodb-database-in-cm4-yu" title="Permalink to this headline">¶</a></h3>
<p>We add the database into <code class="docutils literal notranslate"><span class="pre">cm4</span></code> with two reasons:</p>
<ul class="simple">
<li>provide the information of nodes in different providers.</li>
<li>record the experiment executed through cm4, easy for next re-execution.</li>
</ul>
<p>Every time the user use the <code class="docutils literal notranslate"><span class="pre">cm4</span></code> platform, the server would access the running MongoDB database, querying the nodes’
information, showing relative metadata, and then updating all necessary data.</p>
<p>The <em>MongoDB</em> would finish below tasks:</p>
<ul class="simple">
<li>saving all information:<ol>
<li>the nodes’ information queried from cloud service, like name, id, status, and other metadata about this node.</li>
<li>saving the executing or executed experiment information, like which node we run the experiment, the input, the
command, and the output.</li>
<li>saving the group information users defined.</li>
</ol>
</li>
<li>updating any changes:<ol>
<li>the changes updated on the nodes, like stop running node, or start stopped node.</li>
<li>the changes updated on the [<code class="docutils literal notranslate"><span class="pre">cloudmesh4.yaml</span></code>], like add new nodes.</li>
<li>when the experiment is done, output and experiment status would be updated.</li>
<li>new group is created while using <code class="docutils literal notranslate"><span class="pre">cm4</span></code> will be updated</li>
</ol>
</li>
<li>return required information:<ol>
<li>return the node information, group information, and experiment information when <code class="docutils literal notranslate"><span class="pre">cm4</span></code> queries them.</li>
</ol>
</li>
</ul>
<div class="section" id="data-scheme-in-mongodb">
<span id="data-scheme-in-mongodb"></span><h4>9.2.4.1. Data Scheme in MongoDB<a class="headerlink" href="#data-scheme-in-mongodb" title="Permalink to this headline">¶</a></h4>
<p>There are three types of documents in MongoDB:</p>
<ul>
<li><p class="first">Node information in <code class="docutils literal notranslate"><span class="pre">cloud</span></code> collection.
Different cloud service providers would return different schemas of node information. It is hard to manipulate
different nodes’ information into same schema, so we decide to dump the return mesaage into MongoDB without
any changes.</p>
</li>
<li><p class="first">Node’s experiment status in <code class="docutils literal notranslate"><span class="pre">status</span></code> collection.
The document in <code class="docutils literal notranslate"><span class="pre">status</span></code> collection is going to save the information of experiments executed in a node.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>{&#39;_id&#39;: node_id,
&#39;status&#39;: status,
&#39;currentJob&#39;: job_id,
&#39;history&#39; : the history of executed experiments in this node}
</pre></div>
</div>
</li>
<li><p class="first">Experiment information in <code class="docutils literal notranslate"><span class="pre">job</span></code> collection.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>{&#39;_id&#39;: experiment_id
&#39;name&#39;: name,
&#39;status&#39;: status,
&#39;input&#39;: input_info,
&#39;output&#39;: output_info,
&#39;description&#39;: description,
&#39;commands&#39;: commands}
</pre></div>
</div>
</li>
<li><p class="first">Group information in <code class="docutils literal notranslate"><span class="pre">group</span></code> collection.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>{&#39;cloud&#39;: cloud,
&#39;name&#39;: name,
&#39;size&#39;: size,
&#39;vms&#39;: list_vms}
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="security-in-mongodb">
<span id="security-in-mongodb"></span><h4>9.2.4.2. Security in MongoDB<a class="headerlink" href="#security-in-mongodb" title="Permalink to this headline">¶</a></h4>
<p>For data security purpose, we enable the MongoDB security functionality in <code class="docutils literal notranslate"><span class="pre">cm4</span></code>.</p>
<p>When users first time start the <em>MongoDB</em>, they have to add an account and open an port to access all database in MongoDB. Because we save all nodes’ information into MongoDB inclduing the <em>Authorization</em> information. If your MongoDB is open to everyone, it is easy for hacker to steal your information. So you are requried to set the <em>username</em> and <em>password</em> for the security purpose.</p>
<p>If you want to learn more about the <em>Security</em> in MongoDB, you can visit this <a class="reference external" href="https://docs.mongodb.com/manual/security/">page</a> or visit the brief introduction about the MongoDB</p>
<p>Here is a quick reference about how to
<a class="reference external" href="https://medium.com/&#64;raj_adroit/mongodb-enable-authentication-enable-access-control-e8a75a26d332">enable MongoDB Security</a> option.</p>
</div>
<div class="section" id="install-mongodb-into-local">
<span id="install-mongodb-into-local"></span><h4>9.2.4.3. Install MongoDB Into Local<a class="headerlink" href="#install-mongodb-into-local" title="Permalink to this headline">¶</a></h4>
<p>If you want to know how to install MongoDB into local, you can review <a class="reference external" href="https://docs.mongodb.com/manual/installation/">Install MongoDB</a></p>
<p>And if you want to use <code class="docutils literal notranslate"><span class="pre">cm4</span></code> to help you install MongoDB, you have to update the information required for installing MongoDB into [<code class="docutils literal notranslate"><span class="pre">cloudmesh4.yaml</span></code>] file.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">cm4/cmmongo/MongoDBController.py</span></code> has the functions to install MongoDB for Linux and Darwin system.</p>
<p>The logic of installing MongoDB is:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>1. install prepared tools
2. download the MonoDB .tgz tarball
3. extract file from tarball
4. update the PATH environment 
5. create data and log directories
6. create the mongodb configuration file
</pre></div>
</div>
<p>When we finish installing MongoDB to local, we have to:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>7. run the MongoDB
8. add new role for user to access the database
9. stop MongoDB
10. enable the security setting in configuration file
</pre></div>
</div>
</div>
<div class="section" id="insert-and-update-documents-in-mongodb">
<span id="insert-and-update-documents-in-mongodb"></span><h4>9.2.4.4. Insert and Update Documents in MongoDB<a class="headerlink" href="#insert-and-update-documents-in-mongodb" title="Permalink to this headline">¶</a></h4>
<p>We have different documents in different collections. The operations in <code class="docutils literal notranslate"><span class="pre">cm4/vm/Vm.py</span></code> will call <code class="docutils literal notranslate"><span class="pre">mongoDB.py</span></code> to accomplish
inserting and updating the document.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>insert_cloud_document(document) : insert the document into &#39;cloud&#39; collection
insert_status_document(document) : insert the document into &#39;status&#39; collection
insert_job_document(document) : insert the document into &#39;job&#39; collection
insert_group_document(document) : insert the document into &#39;group&#39; collection
update_document(collection_name, key, value, info) : update the new information into the
                                                     the document queried by &#39;key : value&#39; 
                                                     in collection_name&#39; collection
find_document(collection_name, key, value) : get a document by &#39;key : value&#39; from 
                                             &#39;collection_name&#39; collection
find(collection_name, key, value) : get documents satisfied with &#39;key : value&#39; from 
                               &#39;collection_name&#39; collection
delete_document(collection_name, key, value) : delete the document satisfied with &#39;key : value&#39;
                                               from &#39;collection_name&#39; collection
</pre></div>
</div>
</div>
</div>
<div class="section" id="the-virtual-machine-provider">
<span id="the-virtual-machine-provider"></span><h3>9.2.6. The Virtual Machine Provider<a class="headerlink" href="#the-virtual-machine-provider" title="Permalink to this headline">¶</a></h3>
<div class="section" id="execute-command-in-mongodb">
<span id="execute-command-in-mongodb"></span><h4>9.2.5.1. Execute Command in  MongoDB<a class="headerlink" href="#execute-command-in-mongodb" title="Permalink to this headline">¶</a></h4>
<p>To grant users more power in manipulating their local MongoDB database, we also
add functions for users to execute their customized mongoDB command as if they can
use mongoDB client throught terminal by db_command(command) function.
And in order to handle the various exceptions and errors which might occur when
executing the command, we also add the db_connection() function to help contain those
unexpected results.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>db_command(command): issue a command string to virtual mongoDB shell
db_connection: test connection to local mongoDB host
</pre></div>
</div>
</div>
</div>
<div class="section" id="the-virtual-machine-provider">
<span id="id1"></span><h3>9.2.6. 4. The Virtual Machine Provider<a class="headerlink" href="#the-virtual-machine-provider" title="Permalink to this headline">¶</a></h3>
<p>In the <code class="docutils literal notranslate"><span class="pre">cm4</span></code>, we developed the <code class="docutils literal notranslate"><span class="pre">cm4/vm/Vm.py</span></code> class to implement the operations for different virtual machines from AWS,
Azure, and Chameleon by using the python library <a class="reference external" href="https://libcloud.apache.org"><em>Apache Libcloud</em></a> to interact with
cloud service providers.</p>
<p>The basic functions are:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>1. start(vm_name) : start the virtual machine with specified name
2. stop(vm_name, deallocate) : stop the virtual machine with specified name
3. resume(vm_name) : resume the suspended virtual machine with specified name
4. suspend(vm_name) : suspend the running virtual machine with specified name
5. destroy(vm_name) : destroy the virtual machine with specified name
6. list() : list all virtual machine in your cloud service account
7. status(vm_name) : show the working status of virtual machine with specified name
8. info(vm_name) : show all information about the virtual machine with specified name
9. get_public_ips(vm_name) : return the public ip of the virtual machine with specified name
10. set_public_ip(vm_name, public_ip): set the public ip for the virtual machine with specified name
11. remove_public_ip(vm_name) : remove the public ip from virtual machine with specified name
</pre></div>
</div>
<p>Below we list some sample of running these functions for virtual machines in  AWS, Azure and Openstack.</p>
</div>
<div class="section" id="aws-vm-operations-yu">
<span id="aws-vm-operations-yu"></span><h3>9.2.7. AWS VM Operations (Yu)<a class="headerlink" href="#aws-vm-operations-yu" title="Permalink to this headline">¶</a></h3>
<p>Before using the AWS Vm code, user has to update their AWS information into <code class="docutils literal notranslate"><span class="pre">cloudmesh4.yaml</span></code> file in <em>etc</em> folder.</p>
<p>The <em>Libcloud</em> library has enough methods to support the operations for managing virtual machines in AWS. We use a
<code class="docutils literal notranslate"><span class="pre">cm4/vm/Aws.py</span></code> to create the driver based on the configuration to connect to AWS.</p>
<p>Inherit the <em>Libcloud</em> library, we did some modifications on <code class="docutils literal notranslate"><span class="pre">AWSDriver</span></code> to extend the operation. The <code class="docutils literal notranslate"><span class="pre">create_node</span></code>
method would create a virtual machine in AWS based on the configuration of <code class="docutils literal notranslate"><span class="pre">cloudmesh4.yaml</span></code> file</p>
<p>Here are some samples for running these operations by using <code class="docutils literal notranslate"><span class="pre">cm4</span></code>:</p>
<p>First, user would create the virtual machine in AWS.</p>
<div class="highlight-commandline notranslate"><div class="highlight"><pre><span></span>$ cm4 vm create
Collection(Database(MongoClient(host=[&#39;127.0.0.1:27017&#39;], document_class=dict, tz_aware=False, connect=True), &#39;cloudmesh&#39;), &#39;cloud&#39;)
Thread: updating the status of node
Created base-cloudmesh-yuluo-4
PING 52.39.13.229 (52.39.13.229): 56 data bytes

--- 52.39.13.229 ping statistics ---
1 packets transmitted, 0 packets received, 100.0% packet loss
</pre></div>
</div>
<p>then <strong>MongoDB</strong> will have below record in <code class="docutils literal notranslate"><span class="pre">cloud</span></code> collection.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>{ &quot;_id&quot; : ObjectId(&quot;5c09c65f56c5a939942a9911&quot;), 
&quot;id&quot; : &quot;i-01ca62f33728f4931&quot;, 
&quot;name&quot; : &quot;base-cloudmesh-yuluo-4&quot;, 
&quot;state&quot; : &quot;running&quot;, 
&quot;public_ips&quot; : [ &quot;52.39.13.229&quot; ], 
...}
</pre></div>
</div>
<p>If user want to stop the virtual machine, then he has to type below command with virtual machine name. The code will return
you the virtual machine from MongoDB record with a thread updating the new information. When the thread is done, you can use
<code class="docutils literal notranslate"><span class="pre">status</span></code> method to check the status of the virtual machine.</p>
<div class="highlight-commandline notranslate"><div class="highlight"><pre><span></span>$ cm4 vm stop --vms=base-cloudmesh-yuluo-4
Thread: updating the status of node
{&#39;_id&#39;: ObjectId(&#39;5c09c65f56c5a939942a9911&#39;), 
&#39;id&#39;: &#39;i-01ca62f33728f4931&#39;, 
&#39;name&#39;: &#39;base-cloudmesh-yuluo-4&#39;, 
&#39;state&#39;: &#39;running&#39;, 
&#39;public_ips&#39;: [&#39;52.39.13.229&#39;],
...}
$ cm4 vm status --vms=base-cloudmesh-yuluo-4
stopped
</pre></div>
</div>
<p>When user wants to start the stopped virtual machine, he has to type the command of below sample.</p>
<div class="highlight-commandline notranslate"><div class="highlight"><pre><span></span>$ cm4 vm start --vms=base-cloudmesh-yuluo-4
Thread: updating the status of node
{&#39;_id&#39;: ObjectId(&#39;5c09c65f56c5a939942a9911&#39;), 
&#39;id&#39;: &#39;i-01ca62f33728f4931&#39;, 
&#39;name&#39;: &#39;base-cloudmesh-yuluo-4&#39;, 
&#39;state&#39;: &#39;stopped&#39;, 
&#39;public_ips&#39;: [],
...}
PING 54.191.109.54 (54.191.109.54): 56 data bytes

--- 54.191.109.54 ping statistics ---
1 packets transmitted, 0 packets received, 100.0% packet loss

$ cm4 vm status --vms=base-cloudmesh-yuluo-4
running
</pre></div>
</div>
<p>There is a way for users to get the public ip of a virtual machine.</p>
<div class="highlight-commandline notranslate"><div class="highlight"><pre><span></span>$ cm4 vm publicip --vms=base-cloudmesh-yuluo-4
{&#39;base-cloudmesh-yuluo-4&#39;: [&#39;54.191.109.54&#39;]}
</pre></div>
</div>
<p>Also, if user wants to know the information of virtual machines under his AWS account, he could do this.</p>
<div class="highlight-commandline notranslate"><div class="highlight"><pre><span></span>$ cm4 vm list
&lt;Node: uuid=9b46e75095f586471e2cfe8ebc6b1021ead0e86b, name=a-b-luoyu-0, state=STOPPED, public_ips=[], 
private_ips=[&#39;172.31.28.147&#39;], provider=Amazon EC2 ...&gt;, 
&lt;Node: uuid=da309c8acbbc7bc1f21295600323d073afffb04a, name=base-cloudmesh-yuluo-1, state=TERMINATED, 
public_ips=[], private_ips=[], provider=Amazon EC2 ...&gt;
&lt;Node: uuid=cb62a083081350da9e6f229aace4b697358a987b, name=base-cloudmesh-yuluo-4, state=RUNNING, 
public_ips=[&#39;54.191.109.54&#39;], private_ips=[&#39;172.31.41.197&#39;], provider=Amazon EC2 ...&gt;,
</pre></div>
</div>
<p>Finally, if user wants to delete the virtual machine, he could do this.</p>
<div class="highlight-commandline notranslate"><div class="highlight"><pre><span></span>$ cm4 vm destroy --vms=base-cloudmesh-yuluo-4
True
</pre></div>
</div>
</div>
<div class="section" id="azure-vm-operation-david">
<span id="azure-vm-operation-david"></span><h3>9.2.8. Azure VM Operation (David)<a class="headerlink" href="#azure-vm-operation-david" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="chameleon-vm-operation-rui-and-kimball">
<span id="chameleon-vm-operation-rui-and-kimball"></span><h3>9.2.9. Chameleon VM Operation (Rui and Kimball)<a class="headerlink" href="#chameleon-vm-operation-rui-and-kimball" title="Permalink to this headline">¶</a></h3>
<p>Same as above, before using the VM Openstack functionalities,
user has to update their Openstack information into the <code class="docutils literal notranslate"><span class="pre">cloudmesh4.yaml</span></code> file (~/.cloudmesh/cloudmesh.yaml by macOS convention).
It is also important to notice that openstack has various providers.
And it is important to specify each of them with correspondent log-in credentials.</p>
<p>Many of the funtions are supported by the <em>Libcloud</em> library. By specifying the config parameters to <code class="docutils literal notranslate"><span class="pre">openstack</span></code> and <code class="docutils literal notranslate"><span class="pre">chameleaon</span></code>,
VM Provider will automatically attach futher operations to openstack primitives.</p>
<p>In order to overcome some issues with service provider (mostly delays in operations like spawing, ip-assignments, refactoring and etc),
we implement timeout mechanism to syncronize status between our local machines and remote providers.
Blocking strategy is used to prevent un-deterministic running result.</p>
<p>Since providers of openstack like Chameleon and Jetstream allow users to
associate customized float ip to their instances, we also develop such functions
to support tasks like this and give more power to users when runing their jobs.</p>
<p>Please refer to AWS VM Operation for examples.
Chameleon Openstack expose same
operations as AWS to users. Notice that before running your command,
you need to make sure the global default cloud parameter has been set
to ‘Chameleon’ by:</p>
<div class="highlight-commandline notranslate"><div class="highlight"><pre><span></span>$ cm4 vm set cloud chameleon
Setting env parameter cloud to: chameleon
Writing updata to cloudmesh.yaml
Config has been updated.
</pre></div>
</div>
</div>
<div class="section" id="vm-refactor-rui">
<span id="vm-refactor-rui"></span><h3>9.2.10. VM Refactor (Rui)<a class="headerlink" href="#vm-refactor-rui" title="Permalink to this headline">¶</a></h3>
<p>In addition, in order to offer more flexibilities to our users, we also developed vmrefactor (<code class="docutils literal notranslate"><span class="pre">cm4/vm/VmRefactor.py</span></code>)
to allow users to customize the flavors of their running instances and services in different providers.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>1. resize(vm_name, size) : resize the virtual machine with specified size object
2. confirm_resize(vm_name) : some providers requires confirmation message to complete resize() operation
3. revert(vm_name) : revert a resize operation. Revert the virtual machine to previous status
4. rename(vm_name, newname) : rename the virtual machine 
5. rebuild(vm_name, image) : rebuild the virtual machine to another image/OS with image object.
</pre></div>
</div>
<p>Currently, major providers usually charge users according to their usage. It might be
finacially wise sometimes to shift between different service size to reduce unnecessary cost.
VmRefactor is designed based on this idea to help users to achieve higher cost efficiency. VmRefactor can also help users navigate
thier management tasks especially when they have many different tasks on the run=.</p>
</div>
</div>
<div class="section" id="flask-rest-api-sachith">
<span id="flask-rest-api-sachith"></span><h2>9.3. Flask Rest API (Sachith)<a class="headerlink" href="#flask-rest-api-sachith" title="Permalink to this headline">¶</a></h2>
<p>The cm4 REST Api is built using flask and provides the cloud information retrieval functionality through HTTP calls.</p>
<div class="section" id="pre-requisites">
<span id="pre-requisites"></span><h3>9.3.1. Pre-requisites<a class="headerlink" href="#pre-requisites" title="Permalink to this headline">¶</a></h3>
<p>Use pip install to install the following packages.</p>
<ul class="simple">
<li>Flask</li>
<li>Flask-PyMongo</li>
</ul>
</div>
<div class="section" id="how-to-run-the-rest-api">
<span id="how-to-run-the-rest-api"></span><h3>9.3.2. How to run the REST API<a class="headerlink" href="#how-to-run-the-rest-api" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cm4 admin rest status
$ cm4 admin rest start
$ cm4 admin rest stop
</pre></div>
</div>
<ul class="simple">
<li>Navigate to the cm directory. example:</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/git/cloudmesh/cm
</pre></div>
</div>
<ul class="simple">
<li>Configure the cm4</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install .
</pre></div>
</div>
<ul class="simple">
<li>Add the MongoDB information in the cm4 configuration file</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vi ~/.cloudmesh/cloudmesh4.yaml
</pre></div>
</div>
<ul class="simple">
<li>Run the REST API</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python cm4/flask_rest_api/rest_api.py
</pre></div>
</div>
</div>
<div class="section" id="api">
<span id="api"></span><h3>9.3.3. API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">/vms/</span></code> : Provides information on all the VMs.</li>
<li><code class="docutils literal notranslate"><span class="pre">/vms/stopped</span></code>  : Provides information on all the stopped VMs.</li>
<li><code class="docutils literal notranslate"><span class="pre">/vms/&lt;id&gt;</span></code> : Provides information on the VM identified by the <id></li>
</ul>
</div>
<div class="section" id="examples">
<span id="examples"></span><h3>9.3.4. Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">Retrieve information about a VM</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl localhost:5000/vms/i-0fad7e92ffea8b345
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="dev-restricting-certain-ips-for-certain-rest-calls">
<span id="dev-restricting-certain-ips-for-certain-rest-calls"></span><h3>9.3.5. Dev - restricting certain ips for certain rest calls<a class="headerlink" href="#dev-restricting-certain-ips-for-certain-rest-calls" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">cm4.flask_rest_api.app</span> <span class="kn">import</span> <span class="n">app</span>


<span class="nd">@app.before_request</span>
<span class="k">def</span> <span class="nf">limit_remote_addr</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span> <span class="o">!=</span> <span class="s1">&#39;10.20.30.40&#39;</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>  <span class="c1"># Forbidden</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="extra-run-command-script-in-aws-by-cm4">
<span id="extra-run-command-script-in-aws-by-cm4"></span><h2>9.4. Extra: Run Command/Script in AWS by <code class="docutils literal notranslate"><span class="pre">cm4</span></code><a class="headerlink" href="#extra-run-command-script-in-aws-by-cm4" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">cm4/aws/CommandAWS.py</span></code> contains some methods to run commands/scripts from local to remote AWS virtual machines.
Any command/script operations executed by <code class="docutils literal notranslate"><span class="pre">CommandAWS.py</span></code> would be saved into MongoDB.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">cm4</span></code>, we use python running <em>ssh</em> client to connect the AWS virtual machines. Before running the commands
or scripts remotely, the <code class="docutils literal notranslate"><span class="pre">CommandAWS.py</span></code> would create the job document in MongoDB for saving the experiment information.
This job document contains the information of virtual machine name, the running command or script, and job status, input,
output and description. Meanwhile, the job document_id would be added into status document of the <code class="docutils literal notranslate"><span class="pre">status</span></code> collection for
describing the job history of each virtual machine.</p>
<p>For example, user wants to run <code class="docutils literal notranslate"><span class="pre">pwd</span></code> command to <code class="docutils literal notranslate"><span class="pre">base-cloudmesh-yulou-5</span></code> machine in AWS.</p>
<div class="highlight-commandline notranslate"><div class="highlight"><pre><span></span>$ cm4 aws run command pwd --vm=base-cloudmesh-yuluo-5
Running command pwdin Instance base-cloudmesh-yuluo-5:
/home/ubuntu
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">job</span></code> collection and <code class="docutils literal notranslate"><span class="pre">status</span></code> collection in MongoDB will have below document:</p>
<div class="highlight-commandline notranslate"><div class="highlight"><pre><span></span>&gt; db.job.find()
{ &quot;_id&quot; : ObjectId(&quot;5c09ff9b284fa4515ee9e204&quot;), &quot;name&quot; : &quot;base-cloudmesh-yuluo-5&quot;, &quot;status&quot; : &quot;done&quot;, 
&quot;input&quot; : &quot;Null&quot;, &quot;output&quot; : &quot;/home/ubuntu\n&quot;, &quot;description&quot; : &quot;single job&quot;, &quot;commands&quot; : &quot;pwd&quot; }
&gt; db.status.find()
{ &quot;_id&quot; : ObjectId(&quot;5c09ff9b284fa4515ee9e205&quot;), &quot;id&quot; : &quot;base-cloudmesh-yuluo-5&quot;, &quot;status&quot; : &quot;No Job&quot;, 
&quot;currentJob&quot; : &quot;Null&quot;, &quot;history&quot; : [ &quot;5c09ff9b284fa4515ee9e204&quot; ] }
</pre></div>
</div>
<p>If user run script file containing ‘#!/bin/sh\npwd’ in <code class="docutils literal notranslate"><span class="pre">base-cloudmesh-yulou-5</span></code> machine:</p>
<div class="highlight-commandline notranslate"><div class="highlight"><pre><span></span>$ cm4 aws run script /Users/yuluo/Desktop/cm.sh --vm=base-cloudmesh-yuluo-5
Running command /Users/yuluo/Desktop/cm.shin Instance base-cloudmesh-yuluo-5:
/home/ubuntu
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">job</span></code> collection and <code class="docutils literal notranslate"><span class="pre">status</span></code> collection in MongoDB will have below document:</p>
<div class="highlight-commandline notranslate"><div class="highlight"><pre><span></span>&gt; db.job.find()
{ &quot;_id&quot; : ObjectId(&quot;5c09ff9b284fa4515ee9e204&quot;), &quot;name&quot; : &quot;base-cloudmesh-yuluo-5&quot;, &quot;status&quot; : &quot;done&quot;, 
&quot;input&quot; : &quot;Null&quot;, &quot;output&quot; : &quot;/home/ubuntu\n&quot;, &quot;description&quot; : &quot;single job&quot;, &quot;commands&quot; : &quot;pwd&quot; }
{ &quot;_id&quot; : ObjectId(&quot;5c0a00a8284fa451d0ab427d&quot;), &quot;name&quot; : &quot;base-cloudmesh-yuluo-5&quot;, &quot;status&quot; : &quot;done&quot;, 
&quot;input&quot; : &quot;#!/bin/sh\npwd&quot;, &quot;output&quot; : &quot;/home/ubuntu\n&quot;, &quot;description&quot; : &quot;single job&quot;, &quot;commands&quot; : &quot;Null&quot; }
</pre></div>
</div>
<div class="highlight-commandline notranslate"><div class="highlight"><pre><span></span>&gt; db.status.find()
{ &quot;_id&quot; : ObjectId(&quot;5c09ff9b284fa4515ee9e205&quot;), &quot;id&quot; : &quot;base-cloudmesh-yuluo-5&quot;, &quot;status&quot; : &quot;No Job&quot;, 
&quot;currentJob&quot; : &quot;Null&quot;, &quot;history&quot; : [ &quot;5c09ff9b284fa4515ee9e204&quot;, &quot;5c0a00a8284fa451d0ab427d&quot; ] }
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="README.html" class="btn btn-neutral float-right" title="10. Cloudmesh cm v4" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="vagrant.html" class="btn btn-neutral" title="8. Vagrant" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Cloudmesh Community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>